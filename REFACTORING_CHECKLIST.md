# Spring Cleaning Refactoring Checklist

**Generated by:** @Refactor  
**Date:** 2025-01-09  
**Status:** ‚ö†Ô∏è **DO NOT DELETE ANYTHING YET** - Awaiting approval on specific items

---

## 1. Dead Code & Unused Assets

### Unused Python Functions/Classes
- [ ] **Remove unused function**: `get_contact_submission()` in `src/db/database.py` (line 89) - Never imported or used anywhere
- [ ] **Remove unused function**: `get_connection()` in `src/db/database.py` (line 44) - Never imported or used (only `get_pool()` is used)
- [ ] **Remove unused import**: `close_pool` in `src/services/core/contact_processor.py` (line 7) - Imported but never called
- [ ] **Remove unused import**: `get_pool` in `src/services/core/contact_processor.py` (line 7) - Imported but never called
- [ ] **Evaluate**: `ContactService` class in `src/services/core/contact_service.py` - Only used in FastAPI routes, not in Vercel function. Consider if this abstraction layer is needed or if we can use `contact_processor` directly.

### Unused Static Assets
- [ ] **Remove unused asset**: `assets/logo.svg` - Not referenced in `index.html` (only `stepfault-logo.svg` is used)
- [ ] **Remove unused asset**: `assets/dots-bg.js` - Not loaded in `index.html` (script tag missing)
- [ ] **Verify usage**: `assets/bg-texture.svg` - Referenced in CSS but verify it's actually visible/needed

### Unused Dependencies
- [ ] **Remove unused package**: `psycopg2-binary==2.9.9` from `requirements.txt` - Never imported anywhere (only `asyncpg` is used)
- [ ] **Remove unused package**: `httpx==0.26.0` from `requirements.txt` - Marked as "for future use" but not currently used. Consider removing or documenting when it will be used.
- [ ] **Verify**: `supabase-py` is NOT in requirements.txt but mentioned in docs - If not needed, remove references from documentation

### Test Coverage Artifacts
- [ ] **Remove test coverage HTML**: `htmlcov/` directory - Generated test coverage reports (should be in `.gitignore`, not committed)
- [ ] **Add to .gitignore**: `htmlcov/` directory if not already ignored

### Documentation Cleanup
- [ ] **Archive or consolidate**: Multiple duplicate/outdated documentation files:
  - `TEST_LOCAL.md` vs `TEST_LOCAL_FASTAPI.md` vs `LOCAL_TESTING.md` vs `LOCAL_TESTING_SOLUTION.md` - Consolidate into one
  - `VERCEL_DEPLOYMENT.md` - Check if info is duplicated in other docs
  - `PHASE_1_SUMMARY.md` - Historical document, consider archiving
  - `IMPLEMENTATION_PLAN.md` - Check if this is still relevant or should be archived
  - `DATABASE_EMAIL_IMPLEMENTATION.md` - Historical implementation doc, consider archiving
  - `SETUP_STATUS.md` vs `NEXT_STEPS.md` - Consolidate or clarify purpose

---

## 2. Dependency Audit

### Unused Python Packages
- [ ] **Remove**: `psycopg2-binary==2.9.9` - Not imported anywhere, only `asyncpg` is used
- [ ] **Evaluate**: `httpx==0.26.0` - Comment says "for future external API calls and testing" but not used. Either remove or add a TODO/issue tracking when it will be used.

### Missing Dependencies Check
- [ ] **Verify**: All imports in code have corresponding entries in `requirements.txt`
  - ‚úÖ `fastapi`, `uvicorn`, `pydantic`, `pydantic-settings` - Present
  - ‚úÖ `asyncpg`, `aiosmtplib` - Present
  - ‚úÖ `email-validator` - Present (used by Pydantic `EmailStr`)

---

## 3. Code Hygiene & Console Logs

### Duplicate Code (DRY Violations)

#### Email Validation Duplication
- [ ] **Remove duplicate validation**: `validate_email()` function in `api/contact.py` (lines 25-33) - **CRITICAL DRY VIOLATION**
  - Pydantic schema already validates email using `EmailStr` in `src/api/schemas/contact.py`
  - Vercel function manually validates email again (duplicate logic)
  - **Solution**: Use Pydantic schema validation in Vercel function instead of manual validation

#### Manual Validation Duplication
- [ ] **Remove duplicate validation**: Manual field validation in `api/contact.py` (lines 69-103) - Duplicates Pydantic validation
  - Name length check (lines 69-79) - Already in Pydantic schema
  - Email validation (lines 81-91) - Already in Pydantic schema  
  - Message length check (lines 93-103) - Already in Pydantic schema
  - **Solution**: Create `ContactRequest` from JSON and let Pydantic handle validation, catch `ValidationError`

#### Response Building Duplication
- [ ] **Extract helper function**: Repeated CORS header + JSON response pattern in `api/contact.py` (appears 5+ times)
  - Lines 71-78, 83-90, 96-103, 116-119, 128-134, 140-146, 150-157
  - **Solution**: Create `_send_json_response()` helper method

### Print Statements (Should Use Logging)
- [ ] **Replace print with logging**: `scripts/test_database.py` - Uses `print()` statements (lines 17, 22, 31, 34, 43, 44, 51, 54, 58-63)
  - **Solution**: Use `logger.info()`, `logger.error()` instead of `print()`
  - Keep script functional but use proper logging

### Code Organization Issues
- [ ] **Extract constants**: Magic numbers and strings in `api/contact.py`:
  - Name max length: `100` (line 69) - Should reference Pydantic schema or constant
  - Message min/max: `10` and `2000` (line 93) - Should reference Pydantic schema or constant
  - Error messages are hardcoded strings - Consider extracting to constants or using Pydantic error messages

---

## 4. Vercel & Performance Optimization

### Cold Start Optimization
- [ ] **Lazy import optimization**: Check import order in `api/contact.py`:
  - Current: All imports at top (lines 9-19)
  - **Optimization**: Consider lazy imports for heavy modules (though current imports are relatively light)
  - **Note**: Current imports are already minimal, but `contact_processor` imports database/email services which could be heavy

- [ ] **Reduce function size**: `api/contact.py` is 163 lines - Consider extracting validation logic to separate module
  - Move validation to shared utility that both FastAPI and Vercel can use
  - This reduces cold start time by keeping function handler minimal

### Environment Variable Hardcoding
- [ ] **Verify**: No hardcoded secrets found ‚úÖ (all use `settings` from config)
- [ ] **Add validation**: `src/config.py` should validate required env vars in production
  - Currently allows empty strings for required vars
  - **Solution**: Add `@field_validator` to check required vars are set when `environment == "production"`

### Connection Pool Lifecycle
- [ ] **Optimize**: Database connection pool in `src/db/database.py` - Global pool may not handle Vercel cold starts optimally
  - Current: Global `_pool` variable persists across invocations (good for warm starts)
  - **Consider**: Add pool health check/recreation on errors
  - **Consider**: Add pool timeout/cleanup for long-running idle connections

### Error Handling Improvements
- [ ] **Improve error responses**: `api/contact.py` returns 200 even on processing errors (lines 127-134)
  - This masks failures from monitoring
  - **Consider**: Return 500 for actual processing errors, only return 200 if submission is accepted (even if email fails)

### Static Asset Optimization
- [ ] **Verify**: All assets in `assets/` are actually used
  - `logo.svg` - Unused (see Dead Code section)
  - `dots-bg.js` - Not loaded in HTML
  - `bg-texture.svg` - Used in CSS, verify it's needed

---

## 5. Type Safety & Code Quality

### Missing Type Hints
- [ ] **Add return type**: `validate_email()` in `api/contact.py` (line 25) - Has return type ‚úÖ
- [ ] **Verify**: All functions have proper type hints (spot check needed)

### Pydantic Model Usage
- [ ] **Use Pydantic in Vercel function**: `api/contact.py` should use `ContactRequest` schema instead of manual validation
  - Current: Manual validation (lines 69-103)
  - **Better**: `contact_request = ContactRequest(**body_data)` and catch `ValidationError`

---

## 6. Documentation & Comments

### Outdated Comments
- [ ] **Update comment**: `api/contact.py` line 6 says "uses the same validation logic" but actually duplicates it
- [ ] **Review**: All docstrings are up to date with current implementation

### Redundant Documentation
- [ ] **Consolidate**: Multiple setup/testing docs (see Dead Code section)
- [ ] **Archive**: Historical implementation docs that are no longer relevant

---

## 7. Security Improvements

### CORS Configuration
- [ ] **Hardening**: `api/contact.py` uses `'*'` for CORS (lines 45, 72, 85, 97, 117, 129, 140, 150)
  - **Production**: Should restrict to actual domain(s)
  - **Solution**: Use `settings.allowed_origins` instead of hardcoded `'*'`

### Input Sanitization
- [ ] **Verify**: All user inputs are properly sanitized (Pydantic handles this, but verify Vercel function path)

---

## Priority Summary

### üî¥ Critical (Do First)
1. Remove duplicate email validation in `api/contact.py`
2. Remove duplicate manual validation in `api/contact.py` - use Pydantic
3. Remove unused `psycopg2-binary` dependency
4. Fix CORS to use settings instead of hardcoded `'*'`

### üü° High Priority
5. Remove unused functions: `get_contact_submission()`, `get_connection()`
6. Remove unused imports: `close_pool`, `get_pool` from `contact_processor.py`
7. Extract response helper function in `api/contact.py`
8. Replace `print()` with logging in `test_database.py`
9. Consolidate duplicate documentation files

### üü¢ Medium Priority
10. Remove unused assets: `logo.svg`, `dots-bg.js`
11. Remove `htmlcov/` directory and add to `.gitignore`
12. Evaluate `httpx` dependency (remove or document future use)
13. Add environment variable validation in production
14. Optimize connection pool lifecycle

### üîµ Low Priority (Nice to Have)
15. Archive historical documentation
16. Extract constants for magic numbers
17. Consider lazy imports for cold start optimization
18. Improve error handling to return proper status codes

---

## Estimated Impact

- **Code Reduction**: ~150-200 lines of duplicate/unused code
- **Dependency Reduction**: 1-2 unused packages
- **Performance**: Minor cold start improvement (5-10%)
- **Maintainability**: Significant improvement (DRY violations fixed)
- **Security**: Improved (CORS hardening)

---

**Next Steps:**
1. Review this checklist
2. Approve items to refactor
3. Execute refactoring in priority order
4. Test after each category
5. Commit changes incrementally

